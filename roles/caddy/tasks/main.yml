---
- name: Ensure Caddy app directory exists
  ansible.builtin.file:
    path: "{{ caddy_app_path }}"
    state: directory
    mode: '0755'

- name: Ensure Caddy data directory exists
  ansible.builtin.file:
    path: "{{ caddy_data_path }}"
    state: directory
    mode: '0755'

- name: Ensure Caddy config directory exists
  ansible.builtin.file:
    path: "{{ caddy_config_path }}"
    state: directory
    mode: '0755'

- name: Deploy Caddy docker-compose configuration
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ caddy_app_path }}/docker-compose.yml"
    mode: '0644'

- name: Deploy Caddyfile configuration
  ansible.builtin.template:
    src: Caddyfile.j2
    dest: "{{ caddy_app_path }}/Caddyfile"
    mode: '0644'
  notify: Reload Caddy

- name: Start Caddy container
  community.docker.docker_compose_v2:
    project_src: "{{ caddy_app_path }}"
    state: present
    pull: missing
  register: caddy_compose_output

- name: Display deployment summary
  ansible.builtin.debug:
    msg:
      - "ðŸ”’ Caddy reverse proxy deployed successfully!"
      - "Caddy is running in host network mode"
      - "HTTP:  port {{ caddy_http_port }}"
      - "HTTPS: port {{ caddy_https_port }}"
      - "Configuration: {{ caddy_app_path }}/Caddyfile"
